<!DOCTYPE html>
<html>
<head>
  <title>Code Blocks Example</title>
  <style>
    .container {
      display: flex;
      flex-direction: row;
    }

    .code {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      overflow: scroll;
      counter-reset: line-number;
      height: 70vh;
    }

    .code .codeline {
      counter-increment: line-number;
      display: list-item;
      padding-left: 1rem;
      margin-left: 1rem;
      font-family: Noto Sans Mono;
    }

    .code .codeline::marker {
      content: counter(line-number);
      color: #aaa;
    }

    /*
    .code :nth-child(even).codeline{
      background-color: #f8f8f8;
    }
    */

    .highlighted {
      background-color: #ffffc0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="code">
      <pre><code id="src"></code></pre>
    </div>
    <div class="code">
      <pre><code id="asm"></code></pre>
    </div>
  </div>

  <script>
    const src = document.getElementById('src');
    const asm = document.getElementById('asm');

    let sourcemap;
    let asmlines = [];

    function isInRange(smap, line, col){
      return (smap.sourcestart.line < line || (smap.sourcestart.line === line && smap.sourcestart.col <= col)) &&
             (smap.sourceend.line > line || (smap.sourceend.line === line && smap.sourceend.col >= col));
    }

    function onmouseover(e){
      if (!sourcemap) return;

      const line = parseInt(e.target.dataset.line);
      const col  = parseInt(e.target.dataset.col );
      if (!line || !col) return;

      const s = sourcemap.find(s => isInRange(s, line, col));
      if (!s) return;

      asm.childNodes.forEach((line, i) => {
        line.classList.remove('highlighted');
      });
      asmlines.filter((_, i) => s.asmstart <= i && i <= s.asmend).forEach(line => {
        line.classList.add('highlighted');
      });
      asmlines[Math.floor((s.asmstart + s.asmend) / 2)].scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        offset: -100
      });
      console.log(s.slpos);
    }

    function loadResultJSON(result){
      sourcemap = result.sourcemap;

      result.src.split('\n').forEach((line, i) => {
        const span = document.createElement('span');
        line.split('').forEach((char, j) => {
          const s = document.createElement('span');
          s.textContent = char;
          s.dataset.line = i + 1;
          s.dataset.col = j + 1;
          s.onmouseover = onmouseover;
          span.appendChild(s);
        });
        span.dataset.line = i + 1;
        span.classList.add('codeline');
        src.appendChild(span);
      });

      asmlines = [];
      result.asm.split('\n').forEach((line, i) => {
        const span = document.createElement('span');
        span.textContent = line;
        span.dataset.line = i + 1;
        asmlines[i+1] = span;
        span.classList.add('codeline');
        asm.appendChild(span);
      });
    }

    let result = "{\"src\": \"function main() -> int\\n{\\n  int $0 = main.fibonacci(20, 0, 1)\\n  return $0\\n}\\n\\nfunction main.fibonacci(int $A0, int $A1, int $A2) -> int\\n{\\n  when ($A0 == 0)\\n  {\\n    return $A2\\n  }\\n  else\\n  {\\n    tailcall main.fibonacci(($A0 - 1), $A2, ($A1 + $A2))\\n  }\\n\\n}\", \"asm\": \"nop   \\nconst r1 1\\nconst r2 214\\nstore r2 r1\\naddi  r1 r1 1\\nconst r2 0\\nstore r2 r1\\nconst r2 0\\naddi  r1 r1 1\\nstore r2 r1\\ncopy  r0 r1\\nconst pc 12\\nconst r2 4993\\nlt    r2 r1 r2\\naddi  r3 pc 6\\nijmp  r3 r2\\nconst r2 0\\nconst r3 -1000000000\\nstore r3 r2\\nconst r3 214\\njump  r3\\naddi  r1 r1 1\\naddi  r1 r1 1\\nconst r2 20\\nstore r2 r1\\naddi  r1 r1 1\\nconst r2 0\\nstore r2 r1\\naddi  r1 r1 1\\nconst r2 1\\nstore r2 r1\\nconst r3 74\\naddi  r1 r1 1\\naddi  r2 pc 8\\nstore r2 r1\\naddi  r1 r1 1\\naddi  r2 r1 -5\\nstore r2 r1\\naddi  r1 r1 1\\nstore r0 r1\\ncopy  r0 r1\\ncopy  pc r3\\naddi  r1 r1 1\\naddi  r2 r0 1\\nload  r2 r2\\nstore r2 r1\\naddi  r3 r0 -1\\nload  r3 r3\\nload  r2 r1\\nstore r2 r3\\naddi  r1 r1 -1\\naddi  r3 r3 -1\\ncopy  r2 r0\\nload  r0 r0\\naddi  r2 r2 -1\\nload  r1 r2\\naddi  r2 r2 -1\\nload  pc r2\\naddi  r1 r1 -1\\naddi  r1 r1 1\\nconst r2 0\\nstore r2 r1\\naddi  r3 r0 -1\\nload  r3 r3\\nload  r2 r1\\nstore r2 r3\\naddi  r1 r1 -1\\naddi  r3 r3 -1\\ncopy  r2 r0\\nload  r0 r0\\naddi  r2 r2 -1\\nload  r1 r2\\naddi  r2 r2 -1\\nload  pc r2\\nconst r2 4994\\nlt    r2 r1 r2\\naddi  r3 pc 6\\nijmp  r3 r2\\nconst r2 0\\nconst r3 -1000000000\\nstore r3 r2\\nconst r3 214\\njump  r3\\naddi  r1 r1 1\\naddi  r2 r0 -1\\nload  r2 r2\\naddi  r2 r2 1\\nload  r2 r2\\nstore r2 r1\\naddi  r1 r1 1\\nconst r2 0\\nstore r2 r1\\nload  r3 r1\\naddi  r1 r1 -1\\nload  r2 r1\\neq    r2 r2 r3\\nstore r2 r1\\nload  r3 r1\\naddi  r1 r1 -1\\naddi  r2 pc 21\\nnjmp  r2 r3\\naddi  r1 r1 1\\naddi  r2 r0 -1\\nload  r2 r2\\naddi  r2 r2 3\\nload  r2 r2\\nstore r2 r1\\naddi  r3 r0 -1\\nload  r3 r3\\nload  r2 r1\\nstore r2 r3\\naddi  r1 r1 -1\\naddi  r3 r3 -1\\ncopy  r2 r0\\nload  r0 r0\\naddi  r2 r2 -1\\nload  r1 r2\\naddi  r2 r2 -1\\nload  pc r2\\naddi  r2 pc 79\\njump  r2\\naddi  r1 r1 1\\naddi  r2 r0 -1\\nload  r2 r2\\naddi  r2 r2 1\\nload  r2 r2\\nstore r2 r1\\naddi  r1 r1 1\\nconst r2 1\\nstore r2 r1\\nload  r3 r1\\naddi  r1 r1 -1\\nload  r2 r1\\nsub   r2 r2 r3\\nstore r2 r1\\naddi  r1 r1 1\\naddi  r2 r0 -1\\nload  r2 r2\\naddi  r2 r2 3\\nload  r2 r2\\nstore r2 r1\\naddi  r1 r1 1\\naddi  r2 r0 -1\\nload  r2 r2\\naddi  r2 r2 2\\nload  r2 r2\\nstore r2 r1\\naddi  r1 r1 1\\naddi  r2 r0 -1\\nload  r2 r2\\naddi  r2 r2 3\\nload  r2 r2\\nstore r2 r1\\nload  r3 r1\\naddi  r1 r1 -1\\nload  r2 r1\\nadd   r2 r2 r3\\nstore r2 r1\\nconst r4 74\\naddi  r2 r0 -2\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r1 -5\\naddi  r3 r1 -1\\nload  r1 r3\\naddi  r1 r1 1\\naddi  r0 r1 5\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\naddi  r2 r2 1\\naddi  r1 r1 1\\nload  r3 r2\\nstore r3 r1\\ncopy  pc r4\\naddi  r1 r1 1\\nconst r2 0\\nstore r2 r1\\naddi  r3 r0 -1\\nload  r3 r3\\nload  r2 r1\\nstore r2 r3\\naddi  r1 r1 -1\\naddi  r3 r3 -1\\ncopy  r2 r0\\nload  r0 r0\\naddi  r2 r2 -1\\nload  r1 r2\\naddi  r2 r2 -1\\nload  pc r2\\nnop   \\n\", \"sourcemap\": [{\"sourcestart\": {\"line\": 15, \"col\": 45}, \"sourceend\": {\"line\": 15, \"col\": 56}, \"asmstart\": 142, \"asmend\": 158, \"slpos\": \"main.fibonacci[0].whenElseBody[0].expr (($A0 - 1), $A2, ($A1 + $A2)).expr ($A1 + $A2)\"}, {\"sourcestart\": {\"line\": 15, \"col\": 40}, \"sourceend\": {\"line\": 15, \"col\": 43}, \"asmstart\": 136, \"asmend\": 141, \"slpos\": \"main.fibonacci[0].whenElseBody[0].expr (($A0 - 1), $A2, ($A1 + $A2)).expr $A2\"}, {\"sourcestart\": {\"line\": 15, \"col\": 29}, \"sourceend\": {\"line\": 15, \"col\": 38}, \"asmstart\": 122, \"asmend\": 135, \"slpos\": \"main.fibonacci[0].whenElseBody[0].expr (($A0 - 1), $A2, ($A1 + $A2)).expr ($A0 - 1)\"}, {\"sourcestart\": {\"line\": 15, \"col\": 28}, \"sourceend\": {\"line\": 15, \"col\": 57}, \"asmstart\": 122, \"asmend\": 158, \"slpos\": \"main.fibonacci[0].whenElseBody[0].expr (($A0 - 1), $A2, ($A1 + $A2))\"}, {\"sourcestart\": {\"line\": 15, \"col\": 5}, \"sourceend\": {\"line\": 15, \"col\": 57}, \"asmstart\": 122, \"asmend\": 199, \"slpos\": \"main.fibonacci[0].whenElseBody[0]\"}, {\"sourcestart\": {\"line\": 11, \"col\": 12}, \"sourceend\": {\"line\": 11, \"col\": 15}, \"asmstart\": 102, \"asmend\": 107, \"slpos\": \"main.fibonacci[0].whenBody_0[0].expr $A2\"}, {\"sourcestart\": {\"line\": 11, \"col\": 5}, \"sourceend\": {\"line\": 11, \"col\": 15}, \"asmstart\": 102, \"asmend\": 119, \"slpos\": \"main.fibonacci[0].whenBody_0[0]\"}, {\"sourcestart\": {\"line\": 9, \"col\": 8}, \"sourceend\": {\"line\": 9, \"col\": 18}, \"asmstart\": 84, \"asmend\": 97, \"slpos\": \"main.fibonacci[0].whenCond_0.expr ($A0 == 0)\"}, {\"sourcestart\": {\"line\": 4, \"col\": 10}, \"sourceend\": {\"line\": 4, \"col\": 12}, \"asmstart\": 43, \"asmend\": 46, \"slpos\": \"main[1].expr $0\"}, {\"sourcestart\": {\"line\": 4, \"col\": 3}, \"sourceend\": {\"line\": 4, \"col\": 12}, \"asmstart\": 43, \"asmend\": 58, \"slpos\": \"main[1]\"}, {\"sourcestart\": {\"line\": 3, \"col\": 34}, \"sourceend\": {\"line\": 3, \"col\": 35}, \"asmstart\": 29, \"asmend\": 31, \"slpos\": \"main[0].expr main.fibonacci(20, 0, 1).expr (20, 0, 1).expr 1\"}, {\"sourcestart\": {\"line\": 3, \"col\": 31}, \"sourceend\": {\"line\": 3, \"col\": 32}, \"asmstart\": 26, \"asmend\": 28, \"slpos\": \"main[0].expr main.fibonacci(20, 0, 1).expr (20, 0, 1).expr 0\"}, {\"sourcestart\": {\"line\": 3, \"col\": 27}, \"sourceend\": {\"line\": 3, \"col\": 29}, \"asmstart\": 23, \"asmend\": 25, \"slpos\": \"main[0].expr main.fibonacci(20, 0, 1).expr (20, 0, 1).expr 20\"}, {\"sourcestart\": {\"line\": 3, \"col\": 26}, \"sourceend\": {\"line\": 3, \"col\": 36}, \"asmstart\": 23, \"asmend\": 31, \"slpos\": \"main[0].expr main.fibonacci(20, 0, 1).expr (20, 0, 1)\"}, {\"sourcestart\": {\"line\": 3, \"col\": 3}, \"sourceend\": {\"line\": 3, \"col\": 36}, \"asmstart\": 22, \"asmend\": 42, \"slpos\": \"main[0]\"}, {\"sourcestart\": {\"line\": 3, \"col\": 12}, \"sourceend\": {\"line\": 3, \"col\": 36}, \"asmstart\": 22, \"asmend\": 42, \"slpos\": \"main[0].expr main.fibonacci(20, 0, 1)\"}]}";
    loadResultJSON(JSON.parse(result));
  </script>
</body>
</html>