<!DOCTYPE html>
<html>
<head>
  <title>usocomp viewer</title>
  <style>
    .topbox {
      display: flex;
      flex-direction: row;
    }
    #fileselector {
      margin-right: auto;
    }
    .container {
      display: flex;
      flex-direction: row;
    }

    .code {
      flex: 1;
      border: 1px solid #ccc;
      height: 50vh;
    }

    .info {
      flex: 1;
      border: 1px solid #ccc;
      height: 40vh;
    }

    .sourcemap {
      background-color: #ff880022;
    }
    .sourcemap_thin {
      background-color: #88ff0008;
    }

    .instexec {
      background-color: #88ff0022;
    }
  </style>
  <link href="https://unpkg.com/@vscode/codicons/dist/codicon.css" rel="stylesheet">
</head>
<body>
  <div class="topbox">
  <select id="fileselector">
  </select>
  <a href="https://github.com/boletales/usocomp" id="ghlink" >Source Repo</a>
  </div>
  <div class="container">
    <div class="code" id="div_src">
    </div>
    <div class="code" id="div_asm">
    </div>
  </div>
  <button id="compile">Compile >>></button> <button id="step" disabled>step</button> <button id="run" disabled>run</button> <button id="reset" disabled>reset</button> <input type="range" id="speed" min="1" max="11" value="2">

  <div id="machine" class="container">
    <div class="info" id="stack_info">
    </div>
    <div class="info" id="machine_info">
    </div>
  </div>
  <script type="module">
    import {compile} from './loadslangc.js';
    import {editor} from './editor.js';
    import Machine from './machine.js';
    import examples from './examples.js';

    const compilebutton = document.getElementById('compile');
    const runbutton = document.getElementById('run');
    const stepbutton = document.getElementById('step');
    const resetbutton = document.getElementById('reset');
    const speedinput = document.getElementById('speed');
    const machineinfo = document.getElementById('machine_info');
    const stackinfo = document.getElementById('stack_info');

    editor.onedit = ()=>{
      compilebutton.disabled = false;
      runbutton.disabled = true;
      stepbutton.disabled = true;
      resetbutton.disabled = true;
    };

    editor.oncompile = ()=>{
      compilebutton.disabled = false;
      runbutton.disabled = false;
      stepbutton.disabled = false;
      resetbutton.disabled = true;
      initMacine();
    };

    let machine;

    function step(){
      resetbutton.disabled = false;
      if(machine){
        let result = machine.step();
        editor.focusAsm(result.lastinst);
        if(result.error){
          editor.setInfo(
            result.error,
            machine.pretty().pretty
          );
          runbutton.disabled = true;
          stepbutton.disabled = true;
          reset();
          return result;
        }else{
          editor.setInfo(
            result.stack.pretty ? result.stack.pretty : "no stack info...",
            result.pretty
          );
        }
        return result;
      }else{
        if(!editor.editing){
          initMacine();
          return step();
        }else{
          return {};
        }
      }
    }

    function initMacine(){
      if(!editor.editing){
        machine = new Machine(editor.editor_asm.getModel().getValue());
      }
    }

    function reset(){
      if(!editor.editing){
        machine = new Machine(editor.editor_asm.getModel().getValue());
      }
      stop();
    }

    function stop(){
      runbutton.textContent = 'run';
      clearTimeout(handle);
      handle = null;
    }

    let handle;
    function run(){
      if(machine){
        clearTimeout(handle);
        let result = step();
        if(!result.error){
          handle = setTimeout(run, speedinput.value == 11 ? 0 : 1000/speedinput.value);
        }
      }else{
        initMacine();
        run();
      }
    }

    function onrun(){
      if(handle){
        stop();
      }else{
        runbutton.textContent = 'stop';
        run();
      }
    }

    compilebutton.addEventListener('click', ()=>{
      compile(editor.editor_src.getModel().getValue()).then(result => {
        editor.loadResultJSON(result);
      });
    });

    runbutton.addEventListener('click', onrun);
    stepbutton.addEventListener('click', step);
    resetbutton.addEventListener('click', ()=>{
      reset();
      stepbutton.disabled = false;
      runbutton.disabled = false;
      resetbutton.disabled = true;
    });

      
    const fileselector = document.getElementById('fileselector');
    examples.forEach(r => {
      const option = document.createElement('option');
      option.value = r.name;
      option.text = r.name;
      fileselector.appendChild(option);
    });

    fileselector.addEventListener('change', (event) => {
      const selected = examples.find(r => r.name === event.target.value);
      editor.loadResultJSON(selected.result);
    });


    fileselector.value = "recTest.slang";
    fileselector.dispatchEvent(new Event('change'));

  </script>
</body>
</html>